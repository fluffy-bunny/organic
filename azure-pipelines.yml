# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master
variables: 
  # Azure Resource Manager connection created during pipeline creation 
  azureSubscription: '39ac48fb-fea0-486a-ba84-e0ae9b06c663' 
  
  # Agent VM image name 
  vmImageName: 'ubuntu-latest' 
  # Function app name 
  functionAppName: '' 

  # Working Directory 
  workingDirectory: '$(System.DefaultWorkingDirectory)/src/azfun-organics' 

stages: 

- stage: Build 
  displayName: Build stage 

  jobs: 
  - job: Build 
    displayName: Build 
    pool: 
      vmImage: $(vmImageName) 

    steps: 
    - task: DotNetCoreCLI@2 
      displayName: Build 
      inputs: 
        command: 'build' 
        projects: | 
          $(workingDirectory)/*.csproj 
        arguments: --output $(System.DefaultWorkingDirectory)/publish_output --configuration Release 

    - task: ArchiveFiles@2 
      displayName: 'Archive files' 
      inputs: 
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)/publish_output' 
        includeRootFolder: false 
        archiveType: zip 
        archiveFile: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip 
        replaceExistingArchive: true 
 
    - publish: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip 
      artifact: drop 

- stage: Deploy 
  displayName: Deploy stage 
  dependsOn: Build 
  condition: succeeded() 


  jobs: 
  - deployment: Deploy 
    displayName: Deploy 
    environment: 'development' 
    pool: 
      vmImage: $(vmImageName) 
    strategy: 
      runOnce: 
        deploy: 
          steps: 
          - task: AzureFunctionApp@1 
            displayName: 'Azure functions app deploy' 
            inputs: 
              azureSubscription: '$(azureSubscription)' 
              appType: functionApp 
              appName: 'azfun-organics' 
              package: '$(Pipeline.Workspace)/drop/$(Build.BuildId).zip' 
              appSettings: -EndPointUri https://team7openhack.documents.azure.com:443/ -PrimaryKey Gr8zc0LrbeJ3j6kYcRis0v0TfA9v8fZNEmBbdxm8vRbxP2eyyvPqQmnxMVE3Ds4CjghQPgFfKYiMrFZggb2URg== -Container Ratings -PartitionKey /productId -Database Team7 
